name: Release build
run-name: Building release version
on:
  workflow_dispatch:
    # Erlaubt die manuelle Ausführung nur auf dem 'main'-Branch.
    branches:
      - main
    inputs:
      job_target:
        description: 'Wähle Plattformen aus'
        required: true
        default: 'all'
        type: choice
        options:
          - windows
          - linux
          - macos
          - all # Exportiert alle drei Plattformen

env:
  # Allgemeine Umgebungsvariablen
  GODOT_VERSION: 4.5
  APPLICATION_NAME: BattleForBachelor
  EXPORT_PATH: build # Konsistenter Basis-Exportpfad

jobs:
  # =================================================================
  # JOB 1: LINUX & WINDOWS (Matrix auf Ubuntu-Runner)
  # =================================================================
  build_desktop:
    # Führen Sie diesen Job aus, wenn Windows, Linux oder 'all' ausgewählt wurde.
    if: |
      github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch' &&
      (github.event.inputs.job_target == 'windows' || github.event.inputs.job_target == 'linux' || github.event.inputs.job_target == 'all')

    runs-on: ubuntu-latest

    strategy:
      matrix:
        # Definiert die Zielplattformen für die Matrix
        platform:
          - name: Linux
            runner: ubuntu-latest
            preset_name: Linux/X11
            target_platform: linux
          - name: Windows
            runner: ubuntu-latest
            preset_name: Windows Desktop
            target_platform: windows

    steps:
      - name: Settings extra variables
        run: echo "DATE=$(date +'%Y-%m-%d')" >> $GITHUB_ENV

      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'

      # Verwenden der godot-ci Action für den Export
      - name: Export ${{ matrix.platform.name }} Release
        uses: godot-ci/godot-build@v2
        with:
          godot_version: ${{ env.GODOT_VERSION }}
          # Verwendet den Preset-Namen aus der Matrix
          export_preset: ${{ matrix.platform.preset_name }}
          # Definiert den Zieldateipfad für die Action
          archive_path: ${{ env.EXPORT_PATH }}/${{ matrix.platform.name }}/${{ env.APPLICATION_NAME }}.${{ matrix.platform.name == 'Windows' && 'exe' || 'x86_64' }}
          target_platform: ${{ matrix.platform.target_platform }}
          export_type: release

      - name: Tar und Upload Artifact
        # Erstellt ein Tar-Archiv aus dem Export-Verzeichnis und lädt es hoch
        run: |
          BUILD_FOLDER=${{ env.EXPORT_PATH }}/${{ matrix.platform.name }}
          ARCHIVE_NAME=${{ env.APPLICATION_NAME }}_${{ matrix.platform.name }}_release_${{ env.DATE }}.tar.gz
          tar -czvf $ARCHIVE_NAME $BUILD_FOLDER
          
          # Upload
          find . -name "*.tar.gz" -exec ls -l {} \;

        # Upload des erstellten Archivs
      - uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APPLICATION_NAME }}_${{ matrix.platform.name }}_release_${{ env.DATE }}
          path: ${{ env.APPLICATION_NAME }}_${{ matrix.platform.name }}_release_${{ env.DATE }}.tar.gz


  # =================================================================
  # JOB 2: MACOS (Separater macOS-Runner)
  # =================================================================
  build_macos:
    # Führen Sie diesen Job nur aus, wenn 'mac' oder 'all' ausgewählt wurde.
    if: |
      github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch' &&
      (github.event.inputs.job_target == 'macos' || github.event.inputs.job_target == 'all')

    runs-on: macos-latest # <- Erforderlich für den macOS-Export

    steps:
      - name: Settings extra variables
        run: echo "DATE=$(date +'%Y-%m-%d')" >> $GITHUB_ENV

      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'

      # Verwenden der godot-ci Action für den Export
      - name: Export macOS Release
        uses: godot-ci/godot-build@v2
        with:
          godot_version: ${{ env.GODOT_VERSION }}
          # Korrekter Preset-Name für macOS
          export_preset: "macOS"
          # Exportpfad für die .app-Datei
          archive_path: ${{ env.EXPORT_PATH }}/macOS/${{ env.APPLICATION_NAME }}.app
          target_platform: osx
          export_type: release
          # WICHTIG: Erlaubt das Bündeln der App für macOS
          # notarize: true # Zum Notarisieren notwendig (erfordert Apple Dev Credentials als Secrets)

      - name: Zip und Upload Artifact
        run: |
          BUILD_FOLDER=${{ env.EXPORT_PATH }}/macOS
          ARCHIVE_NAME=${{ env.APPLICATION_NAME }}_macos_release_${{ env.DATE }}.zip
          # macOS-Apps werden üblicherweise gezippt
          zip -r $ARCHIVE_NAME $BUILD_FOLDER

        # Upload des erstellten Archivs
      - uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APPLICATION_NAME }}_macos_release_${{ env.DATE }}
          path: ${{ env.APPLICATION_NAME }}_macos_release_${{ env.DATE }}.zip